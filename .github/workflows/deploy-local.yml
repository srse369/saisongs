name: Deploy to Local Mac

on:
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Deployment type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - backend-only
          - frontend-only

# This workflow runs on your self-hosted Mac runner
jobs:
  deploy:
    runs-on: self-hosted
    environment: local
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build Frontend
        if: ${{ github.event.inputs.deploy_type != 'backend-only' }}
        run: npm run build
        env:
          VITE_API_URL: /api

      - name: Build Backend
        if: ${{ github.event.inputs.deploy_type != 'frontend-only' }}
        run: npm run build:server

      - name: Restart Backend with PM2
        if: ${{ github.event.inputs.deploy_type != 'frontend-only' }}
        run: |
          # Check if PM2 is available
          if command -v pm2 &> /dev/null; then
            pm2 stop songstudio 2>/dev/null || true
            pm2 start ecosystem.config.cjs --env production 2>/dev/null || \
              pm2 start dist/server/index.js --name songstudio
            pm2 save
            echo "✅ Backend restarted with PM2"
          else
            echo "⚠️ PM2 not installed. Starting with node directly..."
            pkill -f "node dist/server/index.js" 2>/dev/null || true
            nohup node dist/server/index.js > /tmp/songstudio.log 2>&1 &
            echo "✅ Backend started"
          fi

      - name: Health Check
        run: |
          sleep 3
          if curl -f -s http://localhost:3111/api/health > /dev/null 2>&1; then
            echo "✅ Backend is running!"
            curl -s http://localhost:3111/api/health | head -c 200
          else
            echo "❌ Backend health check failed"
            exit 1
          fi

      - name: Summary
        run: |
          echo ""
          echo "✅ Local deployment complete!"
          echo ""
          echo "Frontend: http://localhost:5111 (dev) or served by nginx"
          echo "Backend:  http://localhost:3111/api/health"
          echo "Version:  $(node -p "require('./package.json').version")"

